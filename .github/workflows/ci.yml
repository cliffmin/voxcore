name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop, feature/** ]
    tags:
      - 'v*.*.*'
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      debug_enabled:
        type: boolean
        description: 'Run with debug logging'
        required: false
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  JAVA_VERSION: '17'
  GRADLE_VERSION: '8.5'
  WHISPER_MODEL: 'base.en'

jobs:
  # Java tests - Core functionality
  java-tests:
    name: Java Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v5
    
    - name: Set up Java
      uses: actions/setup-java@v5
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
        
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4
      with:
        gradle-version: ${{ env.GRADLE_VERSION }}
        
    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
    
    - name: Build Java post-processor (no tests; produce dist jar)
      run: |
        cd whisper-post-processor
        gradle clean buildAll --no-daemon --stacktrace
        
    - name: Run Java unit tests (unit only)
      run: |
        cd whisper-post-processor
        gradle test --no-daemon

    - name: Generate test report
      if: github.ref == 'refs/heads/main'
      run: |
        cd whisper-post-processor
        gradle jacocoTestReport --no-daemon
    
    - name: Upload coverage to Codecov
      if: github.ref == 'refs/heads/main'
      uses: codecov/codecov-action@v4
      with:
        files: ./whisper-post-processor/build/reports/jacoco/test/jacocoTestReport.xml
        token: ${{ secrets.CODECOV_TOKEN }}
        flags: unittests
        name: codecov-voxcore
        fail_ci_if_error: false
        
    - name: Upload JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: whisper-post-processor
        path: whisper-post-processor/dist/whisper-post.jar

  # Integration tests - Whisper and audio processing (explicit)
  integration-tests:
    name: Integration Tests
    runs-on: macos-latest
    needs: java-tests
    continue-on-error: true  # Don't fail entire CI if integration tests fail
    # Only run integration tests on main branch or tagged releases
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - uses: actions/checkout@v5
    
    - name: Set up Java
      uses: actions/setup-java@v5
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Cache Whisper models
      uses: actions/cache@v4
      with:
        path: ~/.cache/whisper
        key: ${{ runner.os }}-whisper-models-v1
        restore-keys: |
          ${{ runner.os }}-whisper-models-
        
    - name: Install system dependencies
      run: |
        brew update || true
        brew install ffmpeg
        brew install --cask hammerspoon || true
        
    - name: Install whisper-cpp (fast)
      run: |
        brew install whisper-cpp || echo "whisper-cpp install failed (non-blocking)"
        # Download base model if not cached
        mkdir -p ~/.cache/whisper
        if [ ! -f ~/.cache/whisper/ggml-base.en.bin ]; then
          echo "Downloading Whisper base.en model..."
          curl -L --fail --retry 3 "https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-base.en.bin" \
               -o ~/.cache/whisper/ggml-base.en.bin || echo "Model download failed (non-blocking)"
        else
          echo "✓ Whisper model already cached"
        fi
        
    - name: Install OpenAI Whisper (fallback)
      run: |
        python -m pip install --upgrade pip
        pip install openai-whisper
        
    - name: Download test JAR
      uses: actions/download-artifact@v5
      with:
        name: whisper-post-processor
        path: whisper-post-processor/dist/
        
    - name: Run integration tests
      run: |
        cd whisper-post-processor
        # Run integration tests with more detailed output
        gradle integrationTest --no-daemon --info --stacktrace || {
          echo "Integration tests failed, continuing..."
          exit 0
        }

    - name: Integration test summary
      if: always()
      run: |
        echo "=== Integration Test Summary ==="
        awk '/tests/ && /completed/' whisper-post-processor/build/reports/tests/integrationTest/index.html || true

    - name: Daemon health check
      run: |
        bash scripts/testing/daemon_health.sh
        
    - name: Test Whisper pipeline
      run: |
        # Create test audio
        say -o /tmp/test.aiff "Hello, this is a test"
        ffmpeg -i /tmp/test.aiff -ar 16000 -ac 1 /tmp/test.wav -y
        
        # Test whisper-cpp if available
        if command -v whisper-cpp &> /dev/null; then
          echo "Testing whisper-cpp..."
          whisper-cpp --model base.en --output-txt /tmp/test.wav || true
        fi
        
        # Test OpenAI whisper
        echo "Testing OpenAI whisper..."
        whisper /tmp/test.wav --model base.en --output_format txt || true
        
    - name: Test Java post-processor
      run: |
        echo "=== Testing Java post-processor ==="
        
        # Test basic functionality
        echo "Um, this is, uh, a test." | java -jar whisper-post-processor/dist/whisper-post.jar
        
        # Test punctuation restoration
        echo "what is your name" | java -jar whisper-post-processor/dist/whisper-post.jar
        
        # Test with JSON input
        echo '{"text": "hello world"}' | java -jar whisper-post-processor/dist/whisper-post.jar --json
        
        echo "✓ Java post-processor tests passed"

  # Lua and shell script validation
  lua-shell-tests:
    name: Lua & Shell Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v5
    
    - name: Install Lua
      run: sudo apt-get update && sudo apt-get install -y lua5.3
    
    - name: Lua syntax check
      run: |
        echo "=== Checking Lua syntax ==="
        for file in hammerspoon/*.lua; do
          echo "Checking $file..."
          luac5.3 -p "$file" || exit 1
        done
        
    - name: Shellcheck scripts
      run: |
        echo "=== Checking shell scripts ==="
        shellcheck scripts/**/*.sh || echo "⚠️  Shellcheck found issues (non-blocking)"

  # Quick PR validation (fast checks for PRs)
  pr-quick-checks:
    name: PR Quick Checks
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - uses: actions/checkout@v5
    
    - name: Check for merge conflicts
      run: |
        if grep -r "^<<<<<<< " . --exclude-dir=.git; then
          echo "❌ Merge conflict markers found"
          exit 1
        fi
        echo "✅ No merge conflicts"
    
    - name: Validate required docs exist
      run: |
        echo "=== Required documentation ==="
        for doc in README.md LICENSE; do
          [ -f "$doc" ] && echo "✓ $doc" || { echo "✗ $doc missing"; exit 1; }
        done

  # Status check - Required for branch protection
  status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [java-tests, lua-shell-tests]
    if: always()
    
    steps:
    - name: Check status
      run: |
        echo "=== CI Job Status ==="
        echo "java-tests: ${{ needs.java-tests.result }}"
        echo "lua-shell-tests: ${{ needs.lua-shell-tests.result }}"
        echo ""
        
        # Fail only on critical job failures
        if [[ "${{ needs.java-tests.result }}" == "failure" || \
              "${{ needs.lua-shell-tests.result }}" == "failure" ]]; then
          echo "❌ CI failed - critical tests did not pass"
          exit 1
        fi
        
        echo "✅ CI passed"
